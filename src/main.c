#include <rtl.h>
#include "stm32f10x.h"
//#include "rsProcessing.h"

#include "main_task_wifi.h"
#include "main_task_roadsign.h"

//#include "rsImageRefreshing.h"

//extern unsigned char Image[1000];

//tRS RS;
//U32 diode = 0;

//U8 TestImage[16*3*8*4*3/8] =
//{
//0x49, 0x92, 0x24, 0x49, 0x92, 0x24, 0x92, 0x24, 
//0x49, 0x92, 0x24, 0x49, 0x24, 0x49, 0x92, 0x24, 
//0x49, 0x92, 0x01, 0x00, 0x00, 0x00, 0x00, 0x20, 
//0x02, 0x00, 0x00, 0x00, 0x00, 0x40, 0x04, 0x00, 
//0x00, 0x00, 0x00, 0x80, 0x01, 0x10, 0x00, 0x00, 
//0x92, 0x20, 0x02, 0x24, 0x01, 0x00, 0x92, 0x40, 
//0x04, 0x48, 0x02, 0x00, 0x92, 0x80, 0x01, 0x12, 
//0x00, 0x00, 0x24, 0x21, 0x02, 0x00, 0x01, 0x00, 
//0x24, 0x41, 0x04, 0x00, 0x02, 0x00, 0x24, 0x81, 
//0x01, 0x10, 0x00, 0x00, 0x48, 0x22, 0x02, 0x24, 
//0x01, 0x00, 0x48, 0x42, 0x04, 0x40, 0x00, 0x00, 
//0x48, 0x82, 0x01, 0x10, 0x00, 0x00, 0xFE, 0x23, 
//0x02, 0x04, 0x00, 0x00, 0xFE, 0x43, 0x04, 0x00, 
//0x02, 0x00, 0xFE, 0x83, 0x01, 0x92, 0x00, 0x00, 
//0x00, 0x20, 0x02, 0x24, 0x01, 0x00, 0x00, 0x40, 
//0x04, 0x48, 0x02, 0x00, 0x00, 0x80, 0x49, 0x92, 
//0x24, 0x49, 0x92, 0x24, 0x92, 0x24, 0x49, 0x92, 
//0x24, 0x49, 0x24, 0x49, 0x92, 0x24, 0x49, 0x92, 
//0x92, 0x24, 0x49, 0x92, 0x24, 0x49, 0xDB, 0xB6, 
//0x6D, 0xDB, 0xB6, 0x6D, 0xFF, 0xFF, 0xFF, 0xFF, 
//0xFF, 0xFF, 0x02, 0x00, 0x00, 0x00, 0x00, 0x40, 
//0x03, 0x00, 0x00, 0x00, 0x00, 0x60, 0x07, 0x00, 
//0x00, 0x00, 0x00, 0xE0, 0x02, 0x00, 0x01, 0x00, 
//0x92, 0x40, 0x03, 0xB6, 0x01, 0x00, 0x92, 0x60, 
//0x07, 0xFE, 0x03, 0x00, 0x92, 0xE0, 0x02, 0x20, 
//0x01, 0x00, 0x24, 0x41, 0x03, 0x06, 0x00, 0x00, 
//0x24, 0x61, 0x07, 0x0E, 0x00, 0x00, 0x24, 0xE1, 
//0x02, 0x04, 0x01, 0x00, 0x48, 0x42, 0x03, 0xB6, 
//0x01, 0x00, 0x48, 0x62, 0x07, 0xFE, 0x03, 0x00, 
//0x48, 0xE2, 0x02, 0x24, 0x01, 0x00, 0xFE, 0x43, 
//0x03, 0x80, 0x01, 0x00, 0xFE, 0x63, 0x07, 0x8E, 
//0x03, 0x00, 0xFE, 0xE3, 0x02, 0x00, 0x01, 0x00, 
//0x00, 0x40, 0x03, 0xB6, 0x01, 0x00, 0x00, 0x60, 
//0x07, 0xFE, 0x03, 0x00, 0x00, 0xE0, 0x92, 0x24, 
//0x49, 0x92, 0x24, 0x49, 0xDB, 0xB6, 0x6D, 0xDB, 
//0xB6, 0x6D, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
//0x24, 0x49, 0x92, 0x24, 0x49, 0x92, 0xB6, 0x6D, 
//0xDB, 0xB6, 0x6D, 0xDB, 0x6D, 0xDB, 0xB6, 0x6D, 
//0xDB, 0xB6, 0x04, 0x00, 0x00, 0x00, 0x00, 0x80, 
//0x06, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x05, 0x00, 
//0x00, 0x00, 0x00, 0xA0, 0x04, 0x48, 0x02, 0x00, 
//0x92, 0x80, 0x06, 0x6C, 0x03, 0x00, 0x92, 0xC0, 
//0x05, 0xDA, 0x02, 0x00, 0x92, 0xA0, 0x04, 0x00, 
//0x02, 0x00, 0x24, 0x81, 0x06, 0x0C, 0x03, 0x00, 
//0x24, 0xC1, 0x05, 0x8A, 0x02, 0x00, 0x24, 0xA1, 
//0x04, 0x00, 0x02, 0x00, 0x48, 0x82, 0x06, 0x6C, 
//0x03, 0x00, 0x48, 0xC2, 0x05, 0xDA, 0x02, 0x00, 
//0x48, 0xA2, 0x04, 0x40, 0x00, 0x00, 0xFE, 0x83, 
//0x06, 0x0C, 0x03, 0x00, 0xFE, 0xC3, 0x05, 0x80, 
//0x02, 0x00, 0xFE, 0xA3, 0x04, 0x40, 0x00, 0x00, 
//0x00, 0x80, 0x06, 0x6C, 0x03, 0x00, 0x00, 0xC0, 
//0x05, 0xDA, 0x02, 0x00, 0x00, 0xA0, 0x24, 0x49, 
//0x92, 0x24, 0x49, 0x92, 0xB6, 0x6D, 0xDB, 0xB6, 
//0x6D, 0xDB, 0x6D, 0xDB, 0xB6, 0x6D, 0xDB, 0xB6, 
//0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x49, 0x92, 
//0x24, 0x49, 0x92, 0x24, 0xDB, 0xB6, 0x6D, 0xDB, 
//0xB6, 0x6D, 0x07, 0x00, 0x00, 0x00, 0x00, 0xE0, 
//0x01, 0x00, 0x00, 0x00, 0x00, 0x20, 0x03, 0x00, 
//0x00, 0x00, 0x00, 0x60, 0x07, 0x70, 0xE0, 0x3F, 
//0x92, 0xE0, 0x01, 0x10, 0x00, 0x01, 0x92, 0x20, 
//0x03, 0x30, 0x60, 0x1B, 0x92, 0x60, 0x07, 0x7E, 
//0xE0, 0x38, 0x24, 0xE1, 0x01, 0x12, 0x20, 0x01, 
//0x24, 0x21, 0x03, 0x36, 0x00, 0x18, 0x24, 0x61, 
//0x07, 0x70, 0xE0, 0x38, 0x48, 0xE2, 0x01, 0x10, 
//0x00, 0x01, 0x48, 0x22, 0x03, 0x30, 0x60, 0x1B, 
//0x48, 0x62, 0x07, 0x70, 0xE0, 0x38, 0xFE, 0xE3, 
//0x01, 0x10, 0x00, 0x01, 0xFE, 0x23, 0x03, 0x30, 
//0x60, 0x00, 0xFE, 0x63, 0x07, 0xFE, 0xE3, 0x3F, 
//0x00, 0xE0, 0x01, 0x92, 0x20, 0x09, 0x00, 0x20, 
//0x03, 0xB6, 0x61, 0x1B, 0x00, 0x60, 0xFF, 0xFF, 
//0xFF, 0xFF, 0xFF, 0xFF, 0x49, 0x92, 0x24, 0x49, 
//0x92, 0x24, 0xDB, 0xB6, 0x6D, 0xDB, 0xB6, 0x6D,  
//};

//unsigned int XImage[48];

//void nextpoint(void)
//{
//  U32 bit, byte;
//  U16 * pPixel;
//  
//  byte = diode / 8;
//  bit = diode % 8;
//  pPixel = (U16 *)&XImage[byte];
//  *pPixel &= ~(7 << bit);
//  
//  diode += 3;
//  if(diode >= 16*8*3) diode = 0;
//  
//  byte = diode / 8;
//  bit = diode % 8;
//  pPixel = (U16 *)&XImage[byte];
//  *pPixel |= (7 << bit);
//  
//  p20mrgb_unpack2chain((U8 *)XImage, 48, &RS, 1, 1);
//}




__task void MainTask()
{
//  unsigned int x, d, f;
  
//  LEDs_Init();
  
//  for(x = 0; x < sizeof(XImage); x++) XImage[x] = 0x00;

//  Image[  0] = (U8)(0x49);
//  Image[ 26] = (U8)(0xE0);
//  Image[621] = (U8)(0x04);
//  Image[647] = (U8)(0xE0);
  
//  newroadsign_unpack2chain(Image, 96, &RS, 1, 1);
  
//  p20mrgb_unpack2chain((U8 *)TestImage, 576, &RS, 3, 4);

  
//  RS.ChainSize = 8 * 9; //(16 * 8 * 9);
//  RS.WidthInModules = 1;
//  RS.HeightInModules = 1;
//  RS.ModuleWidth = 16;
//  RS.ModuleHeight = 8;
//  RS.SubChainLen = 8; //(16 * 8);
//  
//  for(x = 0; x < RS.ChainSize; x++) RS.Chain[x] = 0x00;
//  RS.Chain[0] = 0xFF;
//  RS.Chain[1] = 0xFF;
//  RS.Chain[2] = 0xFF;
//  RS.Chain[3] = 0xFF;
//  RS.Chain[4] = 0xFF;
//  RS.Chain[5] = 0xFF;
//  RS.Chain[6] = 0xFF;
//  RS.Chain[7] = 0xFF;
//  RS.Chain[0 * 9 + 8] = (7 << 3);
//  RS.Chain[7 * 9 + 8] = (7 << 3);
  
//  ImageRefreshing_Init(&RS);

  //x = 0;
  //d = 1;

  RoadSign_ThreadInit();
  WiFi_ThreadInit();
  
  for(;;)
  {
    //IR_TIM->CCR3 = x;
    
//    LED_STAT_On();
    os_dly_wait(100);
    
    //nextpoint();
    //ImageRefreshing_HW2Toggle();
    
//    Out_Data(d);
//    os_dly_wait(10);

//    Clk_Drv_Hi();
//    os_dly_wait(10);
//    Clk_Drv_Lo();
//    os_dly_wait(10);
//    
//    Lat_Drv_Hi();
//    os_dly_wait(10);
//    Lat_Drv_Lo();
//    os_dly_wait(10);

//    Oe_Drv_Lo();
//    os_dly_wait(150);
//    Oe_Drv_Hi();
    
//    LED_STAT_Off();
    os_dly_wait(100);
    
//    x++;
//    if(x == 128) 
//    {
//      x = 0;
//      d <<= 1;
//      if(d == 8) d = 1;
//    }
  }
}



//U8 direct[64];
//U8 invers[64];

int main()
{
//  for(int i = 0; i < 64; i++)
//  {
//    direct[i] = (63 - i) - (i & 0x0C) * 3 + ((i >> 4) & 3) * 12;
//    
//    invers[i] = (i) + (1 + ((i >> 2) & 3)) * 12 - ((i >> 4) & 3) * 20;
//  }
  
  
  
  DBGMCU->CR |= DBGMCU_CR_DBG_TIM3_STOP;
  
  os_sys_init(MainTask);
  
  while(1)
  {
    //
  }
}
